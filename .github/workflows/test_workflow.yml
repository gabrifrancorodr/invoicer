name: Test Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Test1
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      - name: Uninstall Default Ruby Version
        run: |
          sudo apt-get remove ruby*
      - name: Install Ruby 3.0
        run: |
          sudo apt update
          sudo apt install curl g++ gcc autoconf automake bison libc6-dev libffi-dev libgdbm-dev libncurses5-dev libsqlite3-dev libtool libyaml-dev make pkg-config sqlite3 zlib1g-dev libgmp-dev libreadline-dev libssl-dev
          gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
          curl -sSL https://get.rvm.io | bash -s stable
          source ~/.rvm/scripts/rvm
          rvm install 3.0.0
          rvm use 3.0.0 --default
          ruby -v
      - name: Update Gem Info
        run: |
          echo 'export PATH="/usr/local/opt/ruby/bin:/usr/local/lib/ruby/gems/3.0.0/bin:$PATH"' >> ~/.bash_profile
          sudo apt-get install rubygems
          gem update bundler
          
      - name: Test App Action
        run: |
          bin/rails test
      - name: Deploy App To Heroku
        run: |
          git push heroku main
          bin/setup
          bin/rails server